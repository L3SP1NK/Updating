#!/bin/bash

##	Update:
##	- apt packages
##	- git repositories
##	- flatpak applications
##	- npm packages
##	- Linux firmwares+kernel


loadColorIcon(){
    RC='\e[0m'
    LIGHT='\e[2m'
    GREEN='\e[32m'
    RED='\e[31m'
    ORANGE='\e[33m'
    BLUE='\e[34m\e[3m\e[1m'

    OK=' '
    INFO=' '
    WARN=' '
    FOLDER=' '

}

if [[ ${TERM} == *'256' ]]; then

	loadColorIcon

fi


updateApt(){

	if command -v nala>/dev/null; then

		UPDATER='nala'

	elif command -v apt-get>/dev/null; then

		UPDATER='apt-get'

	fi

    echo -e "\n${RC}${ORANGE}${INFO}Configuring/fixing possibly broken packages...\n${RC}"
    ${UPDATER} install
    dpkg --configure -a

    echo -e "\n${RC}${ORANGE}${INFO}Retrieving new lists of packages...\n${RC}"
    ${UPDATER} update

    echo -e "\n${RC}${ORANGE}${INFO}Installing packages upgrades...\n${RC}"
    ${UPDATER} upgrade
    ${UPDATER} dist-upgrade
    ${UPDATER} full-upgrade

    echo -e "\n${RC}${ORANGE}${INFO}Configuring/fixing possibly broken packages...\n${RC}"
    ${UPDATER} install
    dpkg --configure -a

    echo -e "\n${RC}${ORANGE}${INFO}Removing downloaded archive files and unused packages...\n${RC}"
    ${UPDATER} clean -y
    ${UPDATER} autoclean -y
    ${UPDATER} autoremove --purge -y

}


updateNpm(){

    echo -e "\n${RC}${ORANGE}${INFO}Updating NPM packages...\n${RC}"
    npm update

    echo -e "\n${RC}${ORANGE}${INFO}Checking NPM installation...\n${RC}"
    npm doctor

    echo -e "\n${RC}${ORANGE}${INFO}Auditing NPM packages...\n${RC}"
    npm audit

    echo -e "\n${RC}${ORANGE}${INFO}Fixing NPM packages...\n${RC}"
    npm audit fix

}


updateFlatpak(){

    echo -e "\n${RC}${ORANGE}${INFO}Flatpak applications installed...\n${RC}"
    flatpak list

    echo -e "\n${RC}${ORANGE}${INFO}Checking flatpak applications...\n${RC}"
    flatpak repair -v

    echo -e "\n${RC}${ORANGE}${INFO}Updating flatpak...\n${RC}"
    flatpak update -vy

}


updateGit(){

    GIT_REPO_PATH=( '/opt' '/usr/share/themes' '/usr/share/icons' )
	GIT_REPO_DIR=( $(find "${GIT_REPO_PATH[@]}" -type d -name ".git" 2>/dev/null) )

    for GIT_PATH in "${GIT_REPO_DIR[@]}"
		do

            cd "${GIT_PATH}"
			echo -e "\n${RC}${ORANGE}${FOLDER}Updating ${GIT_PATH}...\n${RC}"
            cd ..

            git config pull.rebase true
            git stash
            git pull

        done

}


updateKernel(){

    FIRMWARE_PKGS=( "firmware-linux" "firmware-linux-free" "firmware-linux-nonfree" )

	for PKG in "${FIRMWARE_PKGS[@]}"
		do

			${UPDATER} install "${PKG}"

	done

    FIRMWARE_PATH="/opt/FIRMWARE/"
    mkdir -p ${FIRMWARE_PATH}
	cd ${FIRMWARE_PATH}

    git clone "https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git" --depth=8 2>/dev/null
    cp -vur ${FIRMWARE_PATH}/linux-firmware/* /lib/firmware/ 2>/dev/null

    update-initramfs -u

}


checkRoot(){
    if [[ ${EUID} -ne '0' ]]
        then

            echo -e "${RED}${WARN}Run me as root!\n${RC}"
            exit 1

    fi
}


checkDone(){

    if [[ ${?} -eq '0' ]]
		then

            echo -e "\n${RC}${GREEN}${OK}Done.\n${RC}"

        else

            echo -e "${RED}${WARN}Ooops!\nSomething went wrong!\n${RC}"
            exit 1

    fi

}


main(){
    ## Update apt packages.

    if which apt-get > /dev/null
        then

            SECONDS='0'

            echo -e "\n${RC}${BLUE}󰏖 Updating APT packages:\n${RC}"
            updateApt || dpkg --audit

            checkDone
            echo -e "\n${RC}${GREEN}${OK}APT packages updated in ${SECONDS} seconds.\n${RC}"

    fi


    ## Update flatpak applications.

    if which flatpak > /dev/null
        then

            SECONDS='0'

            echo -e "\n${RC}${BLUE} Updating Flatpak:\n${RC}"
            updateFlatpak

            checkDone
            echo -e "\n${RC}${GREEN}${OK}Flatpak updated in ${SECONDS} seconds.\n${RC}"

    fi


    ## Update NPM applications.

    if which npm > /dev/null
        then

            SECONDS='0'

            echo -e "\n${RC}${BLUE} Updating NPM packages:\n${RC}"
            updateNpm

            checkDone
            echo -e "\n${RC}${GREEN}${OK}NPM updated in ${SECONDS} seconds.\n${RC}"
    fi


    ## Pull git repos.

    if which git > /dev/null
        then

            SECONDS='0'

            echo -e "\n${RC}${BLUE} Updating Git repositories:\n${RC}"
            updateGit

            checkDone
            echo -e "\n${RC}${GREEN}${OK}Git repositories updated in ${SECONDS} seconds.\n${RC}"

    fi


    SECONDS='0'

    echo -e "\n${RC}${BLUE}${INFO}󰌽 Updating the linux kernel:\n${RC}"
    updateKernel

    checkDone
    echo -e "\n${RC}${GREEN}${OK}Linux kernel updated in ${SECONDS} seconds.\n${RC}"

}



clear && checkRoot && main
